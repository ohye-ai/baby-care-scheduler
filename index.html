<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®å®ç…§æŠ¤æ’ç­è¡¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .baby-name-input {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border: none;
            border-bottom: 2px solid rgba(255,255,255,0.5);
            color: white;
            font-size: 28px;
            font-weight: bold;
            width: 120px;
            text-align: center;
            padding: 2px 8px;
            margin: 0 5px;
        }

        .baby-name-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .baby-name-input:focus {
            outline: none;
            border-bottom-color: white;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .header .reminder {
            font-size: 13px;
            opacity: 0.85;
            font-style: italic;
            line-height: 1.5;
        }

        .info-notice {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 20px 30px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            color: #856404;
        }

        .info-notice strong {
            display: block;
            margin-bottom: 5px;
            color: #856404;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            padding: 30px;
        }

        .left-panel {
            border-right: 2px solid #f0f0f0;
            padding-right: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .member-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .member-card:hover {
            border-color: #667eea;
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .member-info {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
            font-size: 12px;
            padding: 4px 10px;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn-add {
            width: 100%;
            margin-top: 10px;
            background: #51cf66;
            color: white;
        }

        .btn-add:hover {
            background: #40c057;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-small {
            font-size: 12px;
            padding: 6px 12px;
        }

        .time-matrix {
            margin-top: 15px;
        }

        .time-row {
            display: grid;
            grid-template-columns: 80px repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 5px;
            align-items: center;
        }

        .time-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .time-slot {
            padding: 8px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .time-slot.available {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        .time-slot.preferred {
            background: #a5d8ff;
            color: #1864ab;
        }

        .time-slot.unavailable {
            background: #f1f3f5;
            color: #adb5bd;
        }

        .time-slot:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .member-actions {
            display: flex;
            gap: 6px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .member-actions button {
            font-size: 11px;
            padding: 4px 8px;
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
        }

        .member-actions button:hover {
            background: #e9ecef;
            color: #333;
        }

        .member-actions button:active {
            background: #dee2e6;
        }

        .member-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .member-title-name {
            font-weight: 600;
            color: #667eea;
        }

        .btn-reset-hint {
            position: relative;
        }

        .btn-reset-hint:hover::after {
            content: "æ ¹æ®ä¸Šç­/ä¸ä¸Šç­ç±»å‹æ¢å¤é»˜è®¤è§„åˆ™";
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            margin-bottom: 5px;
            z-index: 10;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .schedule-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            font-weight: 500;
            text-align: center;
        }

        .schedule-table td {
            padding: 12px;
            border: 1px solid #e9ecef;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .schedule-table td:hover {
            background: #f8f9ff;
        }

        .schedule-table td.locked {
            background: #fff3bf;
        }

        .schedule-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .caregiver-name {
            font-weight: 600;
            color: #667eea;
        }

        .lock-icon {
            font-size: 10px;
            color: #fab005;
        }

        .week-control {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .contribution-container {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .contribution-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
        }

        .contribution-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #667eea;
        }

        .contribution-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .contribution-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .contribution-message {
            font-size: 12px;
            color: #555;
            font-style: italic;
            line-height: 1.4;
        }

        .export-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-option {
            padding: 12px;
            background: #f8f9ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .modal-option:hover {
            background: #667eea;
            color: white;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .left-panel {
                border-right: none;
                border-bottom: 2px solid #f0f0f0;
                padding-right: 0;
                padding-bottom: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                ğŸ‘¶ <input type="text" class="baby-name-input" id="baby-name" placeholder="å®å®" maxlength="10"> ç…§æŠ¤æ’ç­è¡¨
            </h1>
            <p>è®©æ¯ä¸ªå®¶äººéƒ½æœ‰ä¼‘æ¯æ—¶é—´ï¼Œç§‘å­¦å®‰æ’ç…§æŠ¤è½®æ¢</p>
            <p class="reminder">åˆ«å¿˜äº†å¯¹å½¼æ­¤è¯´å£°è°¢è°¢â€”â€”æ¯ä¸€ä»½ä»˜å‡ºéƒ½å€¼å¾—è¢«çœ‹è§ã€‚å¤šä¸€ç‚¹ç†è§£ï¼Œä¸€èµ·è½»æ¾ä¸€ç‚¹ã€‚</p>
        </div>

        <div class="info-notice">
            <strong>ğŸ’¡ æ¸©é¦¨æç¤º</strong>
            æ’ç­è¡¨çš„æ•°æ®åªä¿å­˜åœ¨ä½ å½“å‰ä½¿ç”¨çš„è®¾å¤‡å’Œæµè§ˆå™¨ä¸­ã€‚å¦‚æœå®¶äººéœ€è¦ä¸€èµ·æŸ¥çœ‹ï¼Œå»ºè®®åœ¨åŒä¸€å°è®¾å¤‡ã€åŒä¸€ä¸ªæµè§ˆå™¨ä¸Šç»´æŠ¤æ’ç­ï¼Œå¹¶å°†æ’ç­ç»“æœæˆªå›¾æˆ–åˆ†äº«ç»™å®¶äººã€‚è¿™æ ·çš„è®¾è®¡å¯ä»¥è®©ä½¿ç”¨æ›´ç®€å•ï¼Œä¹Ÿèƒ½æ›´å¥½åœ°ä¿æŠ¤ä½ å’Œå®¶äººçš„éšç§ï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½ä¸ä¼šè¢«ä¸Šä¼ ã€‚
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§é¢æ¿ï¼šæˆå‘˜ç®¡ç† + æ—¶é—´è¾“å…¥ -->
            <div class="left-panel">
                <div class="section">
                    <div class="section-title">
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­æˆå‘˜
                    </div>
                    <div id="members-list"></div>
                    <button class="btn-add" onclick="addMember()">+ æ·»åŠ æˆå‘˜</button>
                </div>

                <div class="section">
                    <div class="section-title">
                        â° å¯ç”¨æ—¶é—´è®¾ç½®
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-box" style="background: #d3f9d8;"></div>
                            <span>å¯å¸¦</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: #a5d8ff;"></div>
                            <span>åå¥½</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: #f1f3f5;"></div>
                            <span>ä¸å¯å¸¦</span>
                        </div>
                    </div>
                    <div id="availability-matrix"></div>
                </div>

                <button class="btn-primary" style="width: 100%; padding: 12px; font-size: 16px;" onclick="generateSchedule()">
                    ğŸ¯ è‡ªåŠ¨ç”Ÿæˆæ’ç­è¡¨
                </button>
            </div>

            <!-- å³ä¾§é¢æ¿ï¼šæ’ç­è¡¨ + ç»Ÿè®¡ -->
            <div class="right-panel">
                <div class="section">
                    <div class="section-title">
                        ğŸ“… æœ¬å‘¨æ’ç­è¡¨
                        <span style="font-size: 12px; color: #868e96; margin-left: auto;">ï¼ˆç‚¹å‡»æ ¼å­å¯æ‰‹åŠ¨è°ƒæ•´ï¼‰</span>
                    </div>
                    <div class="week-control">
                        <button class="btn-secondary" onclick="moveToNextWeek()">åˆ‡æ¢åˆ°ä¸‹ä¸€å‘¨ï¼ˆæ¸…ç©ºæœ¬å‘¨æ’ç­ï¼‰</button>
                        <button class="btn-secondary btn-small" onclick="clearSchedule()">æ¸…ç©ºå½“å‰æ’ç­</button>
                    </div>
                    <div id="schedule-container"></div>
                </div>

                <div class="section">
                    <div class="section-title">
                        ğŸŒŸ æœ¬å‘¨è´¡çŒ®ä¸€è§ˆ
                    </div>
                    <div id="contribution-container" class="contribution-container"></div>
                </div>

                <div class="export-section">
                    <button class="btn-primary" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡º CSV</button>
                    <button class="btn-secondary" onclick="exportToText()">ğŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è°ƒæ•´äººé€‰å¼¹çª— -->
    <div id="change-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">é€‰æ‹©ç…§æŠ¤äºº</div>
            <div id="modal-options" class="modal-options"></div>
            <button class="btn-secondary" style="width: 100%; margin-top: 15px;" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // ============ æ•°æ®ç»“æ„ ============
        const DAYS = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
        const TIME_SLOTS = ['ä¸Šåˆ', 'ä¸‹åˆ', 'æ™šä¸Š'];
        const ROLES = ['çˆ¸çˆ¸', 'å¦ˆå¦ˆ', 'å¤–å…¬', 'å¤–å©†', 'çˆ·çˆ·', 'å¥¶å¥¶', 'å…¶ä»–'];

        // é¼“åŠ±æ–‡æ¡ˆåº“
        const ENCOURAGEMENT_MESSAGES = [
            'æ¯ä¸€ä¸ªé™ªä¼´çš„æ—¶åˆ»éƒ½å¾ˆçè´µ',
            'ä½ çš„ä»˜å‡ºè®©å®¶æ›´æ¸©æš–',
            'ç…§é¡¾å®å®è¾›è‹¦äº†ï¼Œè®°å¾—ä¹Ÿç…§é¡¾å¥½è‡ªå·±',
            'æ„Ÿè°¢ä½ ä¸ºå®¶äººçš„ä»˜å‡º',
            'ä½ åšå¾—å¾ˆæ£’ï¼Œç»§ç»­åŠ æ²¹',
            'æ¯ä¸ªäººçš„åŠªåŠ›éƒ½å¾ˆé‡è¦',
            'å®å®å› ä¸ºæœ‰ä½ è€Œå¹¸ç¦',
            'è¾›è‹¦äº†ï¼Œä½ æ˜¯æœ€å¥½çš„å®¶äºº',
            'æ„Ÿè°¢ä½ çš„æ¯ä¸€ä»½å…³çˆ±',
            'ä½ çš„é™ªä¼´æ˜¯æœ€å¥½çš„ç¤¼ç‰©'
        ];

        let members = [];
        let availability = {};
        let schedule = {};
        let currentEditCell = null;
        let babyName = '';

        // ============ åˆå§‹åŒ– ============
        function init() {
            loadData();
            
            // æ£€æŸ¥å¹¶ä¿®å¤æ—§æ•°æ®æˆ–ç¼ºå¤±çš„å¯ç”¨æ—¶é—´
            validateAndFixAvailability();
            
            if (members.length === 0) {
                addMember('å¦ˆå¦ˆ', 'å¦ˆå¦ˆ', 'ä¸Šç­');
                addMember('çˆ¸çˆ¸', 'çˆ¸çˆ¸', 'ä¸Šç­');
            }
            
            // åŠ è½½å®å®åå­—
            const savedBabyName = localStorage.getItem('babycare_babyname');
            if (savedBabyName) {
                babyName = savedBabyName;
                document.getElementById('baby-name').value = babyName;
            }
            
            // ç›‘å¬å®å®åå­—å˜åŒ–
            document.getElementById('baby-name').addEventListener('change', function() {
                babyName = this.value;
                localStorage.setItem('babycare_babyname', babyName);
            });
            
            renderMembers();
            renderAvailability();
            renderSchedule();
            renderContribution();
        }

        // ============ æ•°æ®éªŒè¯ä¸ä¿®å¤ ============
        function validateAndFixAvailability() {
            let needsSave = false;
            
            members.forEach(member => {
                // æ£€æŸ¥è¯¥æˆå‘˜æ˜¯å¦æœ‰å¯ç”¨æ—¶é—´æ•°æ®
                if (!availability[member.id]) {
                    // å®Œå…¨ç¼ºå¤±ï¼Œé‡æ–°ç”Ÿæˆ
                    availability[member.id] = getDefaultAvailability(member.type);
                    needsSave = true;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ‰€æœ‰å¿…éœ€çš„æ—¶æ®µ
                let missingSlots = false;
                DAYS.forEach(day => {
                    TIME_SLOTS.forEach(slot => {
                        const key = `${day}-${slot}`;
                        if (!availability[member.id][key]) {
                            missingSlots = true;
                        }
                    });
                });
                
                // å¦‚æœæœ‰ç¼ºå¤±çš„æ—¶æ®µï¼Œé‡æ–°ç”Ÿæˆï¼ˆè¿™å¯èƒ½æ˜¯ç‰ˆæœ¬å‡çº§å¯¼è‡´çš„ï¼‰
                if (missingSlots) {
                    availability[member.id] = getDefaultAvailability(member.type);
                    needsSave = true;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ—¶æ®µéƒ½æ˜¯ 'available'ï¼ˆå¯èƒ½æ˜¯æ—§ç‰ˆæœ¬æ•°æ®ï¼‰
                const allValues = DAYS.flatMap(day => 
                    TIME_SLOTS.map(slot => availability[member.id][`${day}-${slot}`])
                );
                const allAvailable = allValues.every(v => v === 'available');
                
                // å¦‚æœæ‰€æœ‰æ—¶æ®µéƒ½æ˜¯ 'available'ï¼Œè¿™å¯èƒ½æ˜¯åˆå§‹åŒ–æ—¶çš„æ—§æ•°æ®
                // æ£€æŸ¥æˆå‘˜ç±»å‹ï¼Œå¦‚æœåº”è¯¥æœ‰ä¸å¯å¸¦çš„æ—¶æ®µä½†å…¨æ˜¯å¯å¸¦ï¼Œåˆ™é‡ç½®
                if (allAvailable) {
                    const defaultAvail = getDefaultAvailability(member.type);
                    const shouldHaveUnavailable = Object.values(defaultAvail).some(v => v === 'unavailable');
                    
                    if (shouldHaveUnavailable) {
                        // åº”è¯¥æœ‰ä¸å¯å¸¦çš„æ—¶æ®µï¼Œä½†å®é™…å…¨æ˜¯å¯å¸¦ â†’ æ˜¯æ—§æ•°æ®ï¼Œéœ€è¦é‡ç½®
                        availability[member.id] = defaultAvail;
                        needsSave = true;
                    }
                }
            });
            
            if (needsSave) {
                saveData();
            }
        }

        // ============ æ•°æ®æŒä¹…åŒ– ============
        function saveData() {
            localStorage.setItem('babycare_members', JSON.stringify(members));
            localStorage.setItem('babycare_availability', JSON.stringify(availability));
            localStorage.setItem('babycare_schedule', JSON.stringify(schedule));
        }

        function loadData() {
            const savedMembers = localStorage.getItem('babycare_members');
            const savedAvailability = localStorage.getItem('babycare_availability');
            const savedSchedule = localStorage.getItem('babycare_schedule');
            
            if (savedMembers) members = JSON.parse(savedMembers);
            if (savedAvailability) availability = JSON.parse(savedAvailability);
            if (savedSchedule) schedule = JSON.parse(savedSchedule);
        }

        // ============ é»˜è®¤å¯ç”¨æ—¶é—´è§„åˆ™ ============
        function getDefaultAvailability(type) {
            const defaults = {};
            
            DAYS.forEach((day, dayIndex) => {
                const isWeekday = dayIndex < 5; // å‘¨ä¸€åˆ°å‘¨äº”
                
                TIME_SLOTS.forEach(slot => {
                    const key = `${day}-${slot}`;
                    
                    if (type === 'ä¸Šç­') {
                        // ä¸Šç­ï¼šå·¥ä½œæ—¥åªæœ‰æ™šä¸Šå¯å¸¦ï¼Œå‘¨æœ«å…¨å¯å¸¦
                        if (isWeekday) {
                            defaults[key] = slot === 'æ™šä¸Š' ? 'available' : 'unavailable';
                        } else {
                            defaults[key] = 'available';
                        }
                    } else {
                        // ä¸ä¸Šç­ï¼šå·¥ä½œæ—¥å…¨å¯å¸¦ï¼Œå‘¨æœ«ä¸å¯å¸¦
                        defaults[key] = isWeekday ? 'available' : 'unavailable';
                    }
                });
            });
            
            return defaults;
        }

        // ============ æˆå‘˜ç®¡ç† ============
        function addMember(name = '', role = 'çˆ¸çˆ¸', type = 'ä¸Šç­') {
            const id = 'member_' + Date.now();
            members.push({
                id,
                name: name || 'æ–°æˆå‘˜',
                role,
                type,
                maxHours: 8
            });
            
            // ä½¿ç”¨é»˜è®¤è§„åˆ™åˆå§‹åŒ–å¯ç”¨æ€§
            availability[id] = getDefaultAvailability(type);
            
            saveData();
            renderMembers();
            renderAvailability();
        }

        function removeMember(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä½å®¶äººå—ï¼Ÿ')) return;
            members = members.filter(m => m.id !== id);
            delete availability[id];
            
            Object.keys(schedule).forEach(key => {
                if (schedule[key].caregiverId === id) {
                    delete schedule[key];
                }
            });
            
            saveData();
            renderMembers();
            renderAvailability();
            renderSchedule();
            renderContribution();
        }

        function updateMember(id, field, value) {
            const member = members.find(m => m.id === id);
            if (member) {
                const oldType = member.type;
                member[field] = value;
                
                // å¦‚æœæ”¹å˜äº†ç±»å‹ï¼Œé‡ç½®å¯ç”¨æ—¶é—´
                if (field === 'type' && oldType !== value) {
                    availability[id] = getDefaultAvailability(value);
                }
                
                saveData();
                renderMembers();
                if (field === 'type') {
                    renderAvailability();
                }
            }
        }

        function resetMemberAvailability(id) {
            const member = members.find(m => m.id === id);
            if (member && confirm('ç¡®å®šè¦æŒ‰é»˜è®¤è§„åˆ™é‡ç½®æ­¤æˆå‘˜çš„å¯ç”¨æ—¶é—´å—ï¼Ÿ')) {
                availability[id] = getDefaultAvailability(member.type);
                saveData();
                renderAvailability();
            }
        }

        function setAllAvailable(id, status) {
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(slot => {
                    availability[id][`${day}-${slot}`] = status;
                });
            });
            saveData();
            renderAvailability();
        }

        function renderMembers() {
            const container = document.getElementById('members-list');
            container.innerHTML = members.map(member => `
                <div class="member-card">
                    <div class="member-header">
                        <input type="text" value="${member.name}" 
                               onchange="updateMember('${member.id}', 'name', this.value)"
                               style="font-weight: 600; width: 100px;">
                        <button class="btn-danger" onclick="removeMember('${member.id}')">åˆ é™¤</button>
                    </div>
                    <div class="member-info">
                        <select onchange="updateMember('${member.id}', 'role', this.value)">
                            ${ROLES.map(r => `<option ${member.role === r ? 'selected' : ''}>${r}</option>`).join('')}
                        </select>
                        <select onchange="updateMember('${member.id}', 'type', this.value)">
                            <option ${member.type === 'ä¸Šç­' ? 'selected' : ''}>ä¸Šç­</option>
                            <option ${member.type === 'ä¸ä¸Šç­' ? 'selected' : ''}>ä¸ä¸Šç­</option>
                        </select>
                    </div>
                </div>
            `).join('');
        }

        // ============ å¯ç”¨æ—¶é—´çŸ©é˜µ ============
        function renderAvailability() {
            const container = document.getElementById('availability-matrix');
            
            container.innerHTML = members.map(member => `
                <div style="margin-bottom: 20px;">
                    <div class="member-title-row">
                        <span class="member-title-name">${member.name}</span>
                        <div class="member-actions">
                            <button class="btn-reset-hint" onclick="resetMemberAvailability('${member.id}')">
                                é‡ç½®ä¸ºé»˜è®¤
                            </button>
                            <button onclick="setAllAvailable('${member.id}', 'available')">
                                å…¨å¯å¸¦
                            </button>
                            <button onclick="setAllAvailable('${member.id}', 'unavailable')">
                                å…¨ä¸å¯å¸¦
                            </button>
                        </div>
                    </div>
                    <div class="time-row" style="font-weight: 500; font-size: 11px; color: #868e96;">
                        <div></div>
                        ${TIME_SLOTS.map(slot => `<div>${slot}</div>`).join('')}
                    </div>
                    ${DAYS.map(day => `
                        <div class="time-row">
                            <div class="time-label">${day}</div>
                            ${TIME_SLOTS.map(slot => {
                                const key = `${day}-${slot}`;
                                const status = availability[member.id][key] || 'available';
                                return `
                                    <div class="time-slot ${status}" 
                                         onclick="toggleAvailability('${member.id}', '${key}')">
                                        ${status === 'preferred' ? 'â˜…' : status === 'available' ? 'âœ“' : 'âœ—'}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function toggleAvailability(memberId, key) {
            const current = availability[memberId][key];
            const cycle = {
                'available': 'preferred',
                'preferred': 'unavailable',
                'unavailable': 'available'
            };
            availability[memberId][key] = cycle[current];
            saveData();
            renderAvailability();
        }

        // ============ æ’ç­ç®—æ³• ============
        function generateSchedule() {
            const lockedSlots = {};
            Object.keys(schedule).forEach(key => {
                if (schedule[key].locked) {
                    lockedSlots[key] = schedule[key];
                }
            });

            schedule = { ...lockedSlots };

            const slots = [];
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(slot => {
                    const key = `${day}-${slot}`;
                    if (!schedule[key]) {
                        slots.push({ day, slot, key });
                    }
                });
            });

            const assignmentCount = {};
            members.forEach(m => assignmentCount[m.id] = 0);
            Object.values(schedule).forEach(s => {
                assignmentCount[s.caregiverId]++;
            });

            slots.forEach(({ day, slot, key }) => {
                const candidates = members.filter(member => {
                    const status = availability[member.id][key];
                    return status === 'available' || status === 'preferred';
                });

                if (candidates.length === 0) return;

                candidates.sort((a, b) => {
                    const aPreferred = availability[a.id][key] === 'preferred' ? 100 : 0;
                    const bPreferred = availability[b.id][key] === 'preferred' ? 100 : 0;
                    const aCount = assignmentCount[a.id];
                    const bCount = assignmentCount[b.id];
                    
                    return (aPreferred - bPreferred) || (aCount - bCount);
                });

                const selected = candidates[0];
                schedule[key] = {
                    caregiverId: selected.id,
                    locked: false
                };
                assignmentCount[selected.id]++;
            });

            saveData();
            renderSchedule();
            renderContribution();
        }

        // ============ æ’ç­è¡¨æ¸²æŸ“ ============
        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            
            let html = '<table class="schedule-table">';
            html += '<thead><tr><th>æ—¶æ®µ</th>';
            DAYS.forEach(day => html += `<th>${day}</th>`);
            html += '</tr></thead><tbody>';

            TIME_SLOTS.forEach(slot => {
                html += `<tr><td style="background: #f8f9fa; font-weight: 600;">${slot}</td>`;
                DAYS.forEach(day => {
                    const key = `${day}-${slot}`;
                    const assignment = schedule[key];
                    const locked = assignment?.locked ? 'locked' : '';
                    
                    let content = 'â€”';
                    if (assignment) {
                        const member = members.find(m => m.id === assignment.caregiverId);
                        if (member) {
                            content = `
                                <div class="schedule-cell">
                                    <span class="caregiver-name">${member.name}</span>
                                    ${assignment.locked ? '<span class="lock-icon">ğŸ”’</span>' : ''}
                                </div>
                            `;
                        }
                    }
                    
                    html += `<td class="${locked}" onclick="openChangeModal('${key}')">${content}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ============ æ‰‹åŠ¨è°ƒæ•´ ============
        function openChangeModal(key) {
            currentEditCell = key;
            
            const availableMembers = members.filter(member => {
                const status = availability[member.id][key];
                return status === 'available' || status === 'preferred';
            });

            const modalOptions = document.getElementById('modal-options');
            modalOptions.innerHTML = availableMembers.map(member => `
                <div class="modal-option" onclick="assignCaregiver('${key}', '${member.id}')">
                    ${member.name} ${availability[member.id][key] === 'preferred' ? 'â­' : ''}
                </div>
            `).join('');

            if (schedule[key]) {
                modalOptions.innerHTML += `
                    <div class="modal-option" onclick="toggleLock('${key}')" style="background: #fff3bf;">
                        ${schedule[key].locked ? 'ğŸ”“ è§£é™¤é”å®š' : 'ğŸ”’ é”å®šæ­¤æ—¶æ®µ'}
                    </div>
                    <div class="modal-option" onclick="clearSlot('${key}')" style="background: #ffe0e0;">
                        âŒ æ¸…ç©ºæ­¤æ—¶æ®µ
                    </div>
                `;
            }

            document.getElementById('change-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('change-modal').classList.remove('active');
        }

        function assignCaregiver(key, memberId) {
            schedule[key] = {
                caregiverId: memberId,
                locked: schedule[key]?.locked || false
            };
            saveData();
            renderSchedule();
            renderContribution();
            closeModal();
        }

        function toggleLock(key) {
            if (schedule[key]) {
                schedule[key].locked = !schedule[key].locked;
                saveData();
                renderSchedule();
            }
            closeModal();
        }

        function clearSlot(key) {
            delete schedule[key];
            saveData();
            renderSchedule();
            renderContribution();
            closeModal();
        }

        // ============ å‘¨åˆ‡æ¢ ============
        function moveToNextWeek() {
            if (confirm('ç¡®å®šè¦åˆ‡æ¢åˆ°ä¸‹ä¸€å‘¨å—ï¼Ÿå½“å‰æ’ç­å°†è¢«æ¸…ç©ºã€‚')) {
                schedule = {};
                saveData();
                renderSchedule();
                renderContribution();
            }
        }

        function clearSchedule() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æ’ç­å—ï¼Ÿ')) {
                schedule = {};
                saveData();
                renderSchedule();
                renderContribution();
            }
        }

        // ============ è´¡çŒ®ç»Ÿè®¡ ============
        function renderContribution() {
            const container = document.getElementById('contribution-container');
            
            const stats = {};
            members.forEach(m => stats[m.id] = 0);
            Object.values(schedule).forEach(s => {
                if (stats[s.caregiverId] !== undefined) {
                    stats[s.caregiverId]++;
                }
            });

            const html = members.map(member => {
                const count = stats[member.id];
                const message = ENCOURAGEMENT_MESSAGES[Math.floor(Math.random() * ENCOURAGEMENT_MESSAGES.length)];
                
                return `
                    <div class="contribution-card">
                        <div class="contribution-name">${member.name}</div>
                        <div class="contribution-value">${count}</div>
                        <div class="contribution-label">ä¸ªæ—¶æ®µ</div>
                        <div class="contribution-message">${message}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ============ å¯¼å‡ºåŠŸèƒ½ ============
        function exportToCSV() {
            let csv = 'Day,TimeSlot,Caregiver\n';
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(slot => {
                    const key = `${day}-${slot}`;
                    const assignment = schedule[key];
                    if (assignment) {
                        const member = members.find(m => m.id === assignment.caregiverId);
                        csv += `${day},${slot},${member ? member.name : 'æœªå®‰æ’'}\n`;
                    }
                });
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const filename = babyName ? `${babyName}ç…§æŠ¤æ’ç­è¡¨.csv` : 'å®å®ç…§æŠ¤æ’ç­è¡¨.csv';
            link.download = filename;
            link.click();
        }

        function exportToText() {
            const title = babyName ? `${babyName}` : 'å®å®';
            let text = `ğŸ“… ${title}ç…§æŠ¤æ’ç­è¡¨\n\n`;
            
            DAYS.forEach(day => {
                text += `${day}ï¼š\n`;
                TIME_SLOTS.forEach(slot => {
                    const key = `${day}-${slot}`;
                    const assignment = schedule[key];
                    const member = assignment ? members.find(m => m.id === assignment.caregiverId) : null;
                    text += `  ${slot}ï¼š${member ? member.name : 'æœªå®‰æ’'}${assignment?.locked ? 'ğŸ”’' : ''}\n`;
                });
                text += '\n';
            });

            text += 'ğŸ“Š æœ¬å‘¨è´¡çŒ®ä¸€è§ˆï¼š\n';
            members.forEach(member => {
                const count = Object.values(schedule).filter(s => s.caregiverId === member.id).length;
                text += `  ${member.name}ï¼š${count} ä¸ªæ—¶æ®µ\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… æ’ç­è¡¨å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ä»¥ç›´æ¥å‘é€åˆ°å®¶åº­ç¾¤äº†ï¼');
            });
        }

        // ============ å¯åŠ¨åº”ç”¨ ============
        init();
    </script>
</body>
</html>